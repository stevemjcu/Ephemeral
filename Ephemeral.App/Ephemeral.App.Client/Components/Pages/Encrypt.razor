@page "/"
@using System.Text
@inject SecretsApi Api
@inject NavigationManager NavigationManager
@inject IConfiguration Configuration

<PageTitle>Encrypt Secret</PageTitle>

<Submission Description="Encrypt a secret to get a temporary single-use link." Label="Encrypt" Action=EncryptSecret />

@code {
	private TimeSpan DefaultLifetime => TimeSpan.Parse(Configuration["DefaultLifetime"]!);

	private async Task<string> EncryptSecret(string plaintext)
	{
		// 1. Use UTF8 to encode original string as binary data then encrypt
		// 2. Use Base64 to encode binary data as string

		var plaintextEncoded = Encoding.UTF8.GetBytes(plaintext);
		var key = Crypto.GenerateKey();
		var ciphertext = Crypto.Encrypt(plaintextEncoded, key);

		var keyEncoded = Convert.ToBase64String(key);
		var ciphertextEncoded = Convert.ToBase64String(ciphertext);

		var id = await Api.SecretsPOSTAsync(ciphertextEncoded, DefaultLifetime.ToString());
		var builder = new UriBuilder(NavigationManager.BaseUri)
		{
			Path = $"/decrypt/{id}",
			Fragment = keyEncoded,
		};
		return builder.Uri.ToString();
	}
}